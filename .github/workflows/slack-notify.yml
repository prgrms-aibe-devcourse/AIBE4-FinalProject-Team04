name: Slack Notification

on:
  pull_request:
    types: [review_requested]

  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  slack-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Map GitHub User to Slack Member ID
        id: slack-mapper
        shell: bash
        run: |
          # ---------------------------------------------------
          # [1] ìƒí™©ì— ë”°ë¼ íƒ€ê²Ÿ GitHub ì•„ì´ë”” ì¶”ì¶œ
          # ---------------------------------------------------
          TARGET_GITHUB_ID=""
          EVENT_TYPE="${{ github.event_name }}"
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          # ì‚¬ì´ë“œë°”ì—ì„œ ë¦¬ë·°ì–´ë¡œ ì§€ì •
          if [[ "$EVENT_TYPE" == "pull_request" ]]; then
            
            TARGET_GITHUB_ID="${{ github.event.requested_reviewer.login }}"
            MSG_HEADER="ğŸ“¢ ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!"
            PREVIEW_TEXT="ë¦¬ë·°ì–´ë¡œ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # ëŒ“ê¸€ì—ì„œ ë¦¬ë·°ì–´ í˜¸ì¶œ
          elif [[ "$EVENT_TYPE" == "issue_comment" || "$EVENT_TYPE" == "pull_request_review_comment" ]]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            MSG_HEADER="ğŸ’¬ ìƒˆë¡œìš´ ë©˜ì…˜/ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤!"
            if [ ${#COMMENT_BODY} -gt 100 ]; then
              PREVIEW_TEXT="${COMMENT_BODY:0:100} ..."
            else
              PREVIEW_TEXT="$COMMENT_BODY"
            fi
          fi

          # ---------------------------------------------------
          # [2] íŒ€ì› ë§¤í•‘ ë¡œì§
          # ---------------------------------------------------
          SLACK_MENTION=""

          if [[ "$TARGET_GITHUB_ID" == "godqhrenf" ]] || [[ "$COMMENT_BODY" == *"@godqhrenf"* ]]; then
            SLACK_MENTION="$SLACK_MENTION <@U0ACQ0WAY3T>"
          fi

          if [[ "$TARGET_GITHUB_ID" == "Park Goeun" ]] || [[ "$COMMENT_BODY" == *"@Park Goeun"* ]]; then
            SLACK_MENTION="$SLACK_MENTION <@U0AC8LPUHKP>"
          fi
          
          if [[ "$TARGET_GITHUB_ID" == "Juhyeong" ]] || [[ "$COMMENT_BODY" == *"@Juhyeong"* ]]; then
            SLACK_MENTION="$SLACK_MENTION <@U0AC8LPD093>"
          fi
          
          if [[ "$TARGET_GITHUB_ID" == "jk-Nam" ]] || [[ "$COMMENT_BODY" == *"@jk-Nam"* ]]; then
            SLACK_MENTION="$SLACK_MENTION <@U0ACA29BKBQ>"
          fi
          
          # ---------------------------------------------------
          # [3] í™˜ê²½ ë³€ìˆ˜ ì§€ì •
          # ---------------------------------------------------
          echo "SLACK_MENTION=$SLACK_MENTION" >> $GITHUB_ENV
          echo "MSG_HEADER=$MSG_HEADER" >> $GITHUB_ENV
          echo "PREVIEW_TEXT<<EOF" >> $GITHUB_ENV
          echo "$PREVIEW_TEXT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: GitBot
          SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
          SLACK_COLOR: '#36a64f'

          SLACK_TITLE: "${{ env.MSG_HEADER }}"

          SLACK_MESSAGE: |
            *PR:* ${{ github.event.pull_request.title || github.event.issue.title }}
            *ë§í¬:* ${{ github.event.pull_request.html_url || github.event.comment.html_url }}
            *ì‘ì„±ì:* ${{ github.actor }}
            
            *ë‚´ìš©:*
            > ${{ env.PREVIEW_TEXT }}
            
            ${{ env.SLACK_MENTION }} í™•ì¸ ë¶€íƒë“œë ¤ìš”!

          SLACK_FOOTER: 'Powered by GitHub Actions'